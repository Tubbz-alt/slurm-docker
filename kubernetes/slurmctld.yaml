apiVersion: v1
kind: Service
metadata:
  name: slurmctld-0
  labels:
    app: slurmctld-0
spec:
  type: LoadBalancer
  #type: ClusterIP
  ports:
  - name: slurmctld
    protocol: TCP
    port: 6817
  selector:
    role: slurmctld
    rank: primary
---

apiVersion: apps/v1 
kind: StatefulSet
metadata:
  name: slurmctld
spec:
  selector:
    matchLabels:
      role: slurmctld
      rank: primary
  serviceName: slurmctld-0
  replicas: 1
  template:
    metadata:
      labels:
        role: slurmctld
        rank: primary
    spec:
      containers:
      - name: slurmctld
        image: slaclab/slurm-docker:latest
        env:
        - name: SUPERVISORD_CONFIG
          value: "/etc/slurmctld-supervisord.conf"
        - name: SLURMCTLD_ARGS
          value: "-v"
        ports:
        - containerPort: 6817
          name: slurmctld
        volumeMounts:
        - name: slurmctld-config
          mountPath: /etc/slurm
        - name: munge-key
          mountPath: "/mnt/munge"
          readOnly: true
        - name: cache
          mountPath: /var/lib/slurmd/
        readinessProbe:
          tcpSocket:
            port: 6817
          initialDelaySeconds: 10 
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 6817
          initialDelaySeconds: 15
          periodSeconds: 10
      volumes:
      - name: slurmctld-config
        configMap:
          name: slurmctld-config
          items:
          - key: slurm.conf
            path: slurm.conf
          - key: job_submit.lua
            path: job_submit.lua
          - key: slac.conf
            path: slac.conf
          - key: gres.conf
            path: gres.conf
          - key: cgroup.conf
            path: cgroup.conf
      - name: munge-key
        secret:
          secretName: munge
          defaultMode: 256
  volumeClaimTemplates:
  - metadata:
      name: cache
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "slurm-prod--slurmctld-data"
      resources:
        requests:
          storage: 10Gi
